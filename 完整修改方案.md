# 游戏空间固定修改方案

## 需求

- 游戏空间（box）需要固定在虚拟空间中，不随设备移动而变化位置和旋转
- 用户可以通过移动设备来从不同角度查看游戏空间
- 保留双指缩放功能来调整游戏空间大小

## 实现方案

需要修改js/game.js文件中的三个关键函数：

### 1. handleDeviceMotion函数（第877-918行）

**修改前：**
```javascript
// 处理设备运动
function handleDeviceMotion(event) {
    if (!gameStarted) return;
    
    // 获取加速度数据
    const acceleration = event.accelerationIncludingGravity;
    
    if (!acceleration) return;
    
    // 计算加速度变化
    const deltaX = acceleration.x - gameState.lastAcceleration.x;
    const deltaY = acceleration.y - gameState.lastAcceleration.y;
    const deltaZ = acceleration.z - gameState.lastAcceleration.z;
    
    // 更新上一次加速度值
    gameState.lastAcceleration = {
        x: acceleration.x,
        y: acceleration.y,
        z: acceleration.z
    };
    
    // 计算总变化量
    const totalDelta = Math.sqrt(deltaX * deltaX + deltaY * deltaY + deltaZ * deltaZ);
    
    // 如果变化量超过阈值，调整游戏世界位置
    if (totalDelta > 0.5) {
        // 根据加速度变化调整游戏世界位置
        // 使用小系数来平滑移动
        const positionFactor = 0.05;
        
        // 调整游戏世界距离 - 前后移动
        const zChange = deltaZ * positionFactor;
        gameState.gameWorldDistance = THREE.MathUtils.clamp(
            gameState.gameWorldDistance + zChange,
            -5, // 最远距离
            -1  // 最近距离
        );
        
        // 应用位置变化
        updateGameWorldTransform();
    }
}
```

**修改后：**
```javascript
// 处理设备运动
function handleDeviceMotion(event) {
    if (!gameStarted) return;
    
    // 获取加速度数据
    const acceleration = event.accelerationIncludingGravity;
    
    if (!acceleration) return;
    
    // 计算加速度变化
    const deltaX = acceleration.x - gameState.lastAcceleration.x;
    const deltaY = acceleration.y - gameState.lastAcceleration.y;
    const deltaZ = acceleration.z - gameState.lastAcceleration.z;
    
    // 更新上一次加速度值
    gameState.lastAcceleration = {
        x: acceleration.x,
        y: acceleration.y,
        z: acceleration.z
    };
    
    // 注意：移除了更新游戏世界位置的代码，使游戏空间保持固定
}
```

### 2. handleDeviceOrientationForGameWorld函数（第1008-1042行）

**修改前：**
```javascript
// 处理设备方向变化 - 用于游戏世界旋转
function handleDeviceOrientationForGameWorld(event) {
    if (!gameStarted) return;
    
    // 获取设备方向数据
    const alpha = event.alpha || 0; // Z轴旋转 (0-360)
    const beta = event.beta || 0;   // X轴旋转 (-180 到 180)
    const gamma = event.gamma || 0; // Y轴旋转 (-90 到 90)
    
    // 计算方向变化
    const deltaAlpha = alpha - gameState.lastDeviceOrientation.alpha;
    const deltaBeta = beta - gameState.lastDeviceOrientation.beta;
    const deltaGamma = gamma - gameState.lastDeviceOrientation.gamma;
    
    // 更新上一次方向
    gameState.lastDeviceOrientation = { alpha, beta, gamma };
    
    // 计算总变化量
    const totalDelta = Math.abs(deltaAlpha) + Math.abs(deltaBeta) + Math.abs(deltaGamma);
    
    // 如果变化量超过阈值，调整游戏世界旋转
    if (totalDelta > 1.5) {
        // 根据设备方向变化调整游戏世界旋转
        // 使用小系数来平滑旋转
        const rotationFactor = 0.05;
        
        // 更新游戏世界旋转角度
        gameState.gameWorldRotation.y += deltaAlpha * rotationFactor;
        gameState.gameWorldRotation.x += deltaBeta * rotationFactor;
        gameState.gameWorldRotation.z += deltaGamma * rotationFactor;
        
        // 应用旋转
        updateGameWorldTransform();
    }
}
```

**修改后：**
```javascript
// 处理设备方向变化 - 用于游戏世界旋转
function handleDeviceOrientationForGameWorld(event) {
    if (!gameStarted) return;
    
    // 获取设备方向数据
    const alpha = event.alpha || 0; // Z轴旋转 (0-360)
    const beta = event.beta || 0;   // X轴旋转 (-180 到 180)
    const gamma = event.gamma || 0; // Y轴旋转 (-90 到 90)
    
    // 计算方向变化
    const deltaAlpha = alpha - gameState.lastDeviceOrientation.alpha;
    const deltaBeta = beta - gameState.lastDeviceOrientation.beta;
    const deltaGamma = gamma - gameState.lastDeviceOrientation.gamma;
    
    // 更新上一次方向
    gameState.lastDeviceOrientation = { alpha, beta, gamma };
    
    // 注意：移除了更新游戏世界旋转的代码，使游戏空间保持固定
}
```

## 修改步骤

1. 备份原始文件：将js/game.js复制为js/game.js.bak
2. 使用修改后的文件：将js/fixed-game.js复制为js/game.js
3. 刷新浏览器测试修改效果

## 修改效果

修改后，游戏空间将固定在虚拟空间中，不随设备移动而变化位置和旋转。用户可以通过移动设备来从不同角度查看游戏空间，同时保留双指缩放功能来调整游戏空间大小。

## 恢复方法

如果需要恢复原始功能，只需将备份文件js/game.js.bak复制回js/game.js即可。

```bash
# 更新游戏文件
./update-game.sh

# 恢复原始文件
./restore-game.sh
```
